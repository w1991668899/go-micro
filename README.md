# 基于go-micro go微服务架构最佳实践

本框架组件
 - api-gateway http网关转grpc请求
 - echo 框架
 - go-micro 微服务框架
 - etcd 注册中心
 - rabbitmq 消息队列
 - kafka 消息引擎系统
 - logrus、zaplog 日志
 - jwt 
 - OpenTracing 分布式链路追踪
 - cron 定时器


## 这里基于个人的理解对微服务做的一些总结

## 微服务构成
 - 服务描述
 - 服务注册
 - 服务框架
 - 服务监控
 - 服务追中
 - 服务治理
 
## 服务描述

服务如何对外描述，调用某个服务需要提供哪些信息会返回哪些信息，常用方式如下：

 - restful api 
 - xml
 - idl（protobuf）
 
本人工作中使用的是go-micro内部使用grpc通信，所以使用的是protobuf来定义服务接口、参数、返回值等, protobuf具备跨语言能力，而且与go高度相似很简洁

## 服务注册

主要解决服务的发布与订阅，服务生产者将自己的服务发布到注册中心，服务消费者从注册中心订阅服务。注册中心为了保证高可用一般采用分布式集群部署保证高可用

- rpc server 服务提供者，服务在初始化启动的时候需要根据配置信息在注册中心注册，并向注册中心定期发送新跳汇报存货状态
- rpc client 服务调用者，服务在初始化启动的时候需要向注册中心订阅服务并与rpc server建立连接
- 当rpc server节点发生变更会向注册中心同步，rpc client会刷新本地内存中缓存的服务节点列表信息
- rpc client从本地缓存中基于负载均衡算法向rpc server 发起调用

go-micro中支持多种注册方式，本人常用ETCD

**白名单机制**
开发过程中涉及多套环境，为防止将开发、测试、线上环境的服务注册信息搞错，注册中心最好有一个白名单机制，只有添加到白名单中的服务才能完成注册

## 服务框架

- 采用不同的框架会使用不同的通信协议如grpc, tcp, udp等, 建议grpc
- 数据传输采用什么方式, 同步还是异步，单连接还是多路复用
- 数据压缩格式如protobuf, json

# 服务监控

服务消费者与生产者启动后，需要对服务进行监控，随时了解服务运行状况，主要包括：

- 指标收集，如每次服务调用的耗时，是否成功等，将这些数据上传到数据处理中心, 如kafka
- 数据处理， 对日志数据进行统计，如elasticsearch
- 数据战术， 将处理的数据在可视化页面展示

### 监控对象
- 用户端数据
- 接口
- 资源 如redis内存
- 基础设备 如网络，CPU，内存等

### 键控指标
- 请求量 QPS
- 响应时间
- 错误率

# 服务追踪

记录服务间每一次调用的链路，以便进行追踪定位，一般我会在go的context中传入一个request_id, 推荐大家使用[opentracing](https://github.com/opentracing/opentracing-go)
trace_id: 一次请求的全局ID
span_id: 在分布式请求中当前服务的标记，比如服务A调用B，服务B调用C， span_id从0到0.1到0.1.1
annotation: 业务层面标记如uid

# 服务治理

服务追踪定位到了问题，服务治理需要通过一系列手段对服务异常情况进行处理，常见情况如下：

- 单机故障，服务提供者节点摘除
- 服务消费者摘除，如果是服务间网络问题就不能摘除服务者，这时候摘除消费者更合适
- 服务依赖不可用，服务A依赖于服务B，当服务B出现故障一段时间内停止对服务B发起调用。防止服务A被拖垮也给服务B减轻了压力使其尽快恢复








 
 